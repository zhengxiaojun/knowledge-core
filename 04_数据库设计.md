# AI 测试用例自动生成系统  
## 数据库设计文档

**Version:** 1.0  
**文档名称:** AI 测试用例自动生成系统 - 数据库设计文档  
**创建日期:** 2026-01-28  

---

## 1. 数据库架构概览

系统采用**多数据库架构**，分别使用关系数据库、向量数据库和图数据库，各司其职。

### 1.1 数据库分类

| 数据库类型 | 技术选型 | 用途 |
|----|----|----|
| 关系数据库 | MySQL / PostgreSQL | 需求、用例、缺陷、任务等结构化数据 |
| 向量数据库 | Milvus / Qdrant | 测试知识单元向量化表示，语义检索 |
| 图数据库 | Neo4j | 测试知识网络，关系查询与子图扩展 |

---

## 2. 关系数据库设计（MySQL / PostgreSQL）

### 2.1 `requirement_raw` 表

**用途**：存储用户原始需求，完整保留原始信息。

| 字段名 | 类型 | 约束 | 说明 |
|----|----|----|----|
| id | BIGINT | PRIMARY KEY | 自增 ID |
| title | VARCHAR(255) | NOT NULL | 需求标题 |
| full_content | LONGTEXT | NOT NULL | 完整需求内容 |
| source_type | VARCHAR(50) |  | 来源类型：text / pdf / docx / excel |
| source_file | VARCHAR(255) |  | 原始文件名 |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 更新时间 |

---

### 2.2 `requirement_std` 表

**用途**：标准化需求数据，供下游模块统一使用。

| 字段名 | 类型 | 约束 | 说明 |
|----|----|----|----|
| id | BIGINT | PRIMARY KEY | 自增 ID |
| raw_req_id | BIGINT | FOREIGN KEY | 关联原始需求 ID |
| summary | TEXT |  | 需求摘要 |
| business_domain | VARCHAR(100) |  | 业务域 |
| priority | VARCHAR(10) |  | 优先级 P0 / P1 / P2 / P3 |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 创建时间 |

---

### 2.3 `test_point` 表

**用途**：存储抽象后的测试知识单元。

| 字段名 | 类型 | 约束 | 说明 |
|----|----|----|----|
| id | BIGINT | PRIMARY KEY | 自增 ID |
| content | VARCHAR(255) | NOT NULL | 测试点内容 |
| type | VARCHAR(50) | NOT NULL | 类型：TestPoint / Scenario / Risk |
| confidence | DECIMAL(3,2) | DEFAULT 0.5 | 置信度（0–1） |
| vector_id | VARCHAR(100) |  | 向量库 ID |
| graph_id | VARCHAR(100) |  | 图数据库节点 ID |
| source | VARCHAR(50) |  | 来源：requirement / defect / case |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 创建时间 |

---

### 2.4 `test_case` 表

**用途**：存储测试用例数据。

| 字段名 | 类型 | 约束 | 说明 |
|----|----|----|----|
| id | BIGINT | PRIMARY KEY | 自增 ID |
| title | VARCHAR(255) | NOT NULL | 用例标题 |
| precondition | TEXT |  | 前置条件 |
| steps | TEXT | NOT NULL | 测试步骤 |
| expected | TEXT | NOT NULL | 预期结果 |
| related_req_id | BIGINT |  | 关联需求 ID |
| test_point_id | BIGINT |  | 关联测试点 ID |
| status | VARCHAR(20) | DEFAULT 'draft' | 状态：draft / confirmed / executed |
| created_by | VARCHAR(50) |  | 创建者：ai / manual |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 创建时间 |

---

### 2.5 `defect` 表

**用途**：存储缺陷信息。

| 字段名 | 类型 | 约束 | 说明 |
|----|----|----|----|
| id | BIGINT | PRIMARY KEY | 自增 ID |
| defect_id | VARCHAR(100) | UNIQUE | 缺陷系统 ID |
| title | VARCHAR(255) | NOT NULL | 缺陷标题 |
| phenomenon | TEXT |  | 问题现象 |
| root_cause | TEXT |  | 根本原因 |
| related_req_id | BIGINT |  | 关联需求 ID |
| severity | VARCHAR(20) |  | 严重程度 |
| status | VARCHAR(20) |  | 状态 |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 创建时间 |

---

### 2.6 `generation_task` 表

**用途**：记录测试用例生成任务的执行状态。

| 字段名 | 类型 | 约束 | 说明 |
|----|----|----|----|
| id | BIGINT | PRIMARY KEY | 自增 ID |
| raw_req_id | BIGINT |  | 关联原始需求 ID |
| status | VARCHAR(50) | DEFAULT 'INIT' | INIT / RUNNING / DONE / FAILED |
| progress | INT | DEFAULT 0 | 进度百分比 |
| error_message | TEXT |  | 错误信息 |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| finished_at | DATETIME |  | 完成时间 |

---

### 2.7 `generation_result` 表

**用途**：存储生成结果及人工确认状态。

| 字段名 | 类型 | 约束 | 说明 |
|----|----|----|----|
| id | BIGINT | PRIMARY KEY | 自增 ID |
| task_id | BIGINT | FOREIGN KEY | 关联任务 ID |
| test_point_id | BIGINT |  | 测试点 ID |
| test_case_content | LONGTEXT |  | 生成的测试用例内容 |
| approved | BOOLEAN | DEFAULT FALSE | 是否已确认 |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 创建时间 |

---

## 3. 向量数据库设计（Milvus / Qdrant）

### 3.1 Collection 定义

**Collection 名称**：`test_knowledge_vectors`

| 字段名 | 类型 | 说明 |
|----|----|----|
| id | VARCHAR | 测试知识单元唯一标识 |
| embedding | FLOAT_VECTOR(1536) | 向量表示（1536 维） |
| content | VARCHAR | 文本内容 |
| type | VARCHAR | TestPoint / Scenario / Risk |
| graph_id | VARCHAR | 关联图数据库节点 ID |
| confidence | FLOAT | 置信度（0–1） |

---

### 3.2 索引配置

推荐使用 **HNSW** 索引：

- `index_type`: HNSW  
- `metric_type`: COSINE（余弦相似度）  
- `params`:  
  - M = 16  
  - efConstruction = 200  

---

## 4. 图数据库设计（Neo4j）

### 4.1 节点类型

| 节点类型 | 属性 |
|----|----|
| Requirement | id, title, business_domain, priority |
| TestPoint | id, content, type, confidence |
| TestCase | id, title, precondition, steps, expected |
| Defect | id, title, phenomenon, root_cause, severity |

---

### 4.2 关系类型

| 关系类型 | 说明 |
|----|----|
| DERIVE | Requirement → TestPoint（需求衍生测试点） |
| COVERED_BY | TestPoint → TestCase（测试点被用例覆盖） |
| TRIGGERED | TestPoint → Defect（测试点触发缺陷） |
| RELATED_TO | TestCase → Defect（用例关联缺陷） |

---

### 4.3 索引设计

```cypher
CREATE INDEX ON :Requirement(id);
CREATE INDEX ON :TestPoint(id);
CREATE INDEX ON :TestCase(id);
CREATE INDEX ON :Defect(id);
```

---

## 5. 数据一致性设计

### 5.1 跨数据库关联

通过 ID 建立跨库关联关系：

* MySQL `test_point.vector_id` → Milvus Collection ID
* MySQL `test_point.graph_id` → Neo4j Node ID
* 关系数据库作为**主数据源和索引中心**

---

### 5.2 事务处理策略

采用**最终一致性**策略：

1. 先写入关系数据库（主数据源）
2. 异步写入向量数据库和图数据库
3. 写入失败时记录补偿日志
4. 定时任务扫描补偿日志并重试失败操作

---

### 5.3 数据清理策略

* 测试用例保留周期：**2 年**
* 生成任务记录保留周期：**6 个月**
* 测试知识单元长期保留，低置信度数据定期归档
