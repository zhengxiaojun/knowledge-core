# AI 测试用例自动生成系统  
## 部署设计文档

**Version:** 1.0  
**文档名称:** AI 测试用例自动生成系统 - 部署设计文档  
**创建日期:** 2026-01-28  

---

## 1. 部署架构概览

系统支持三种部署模式，可根据团队规模和业务成熟度选择合适方案。

### 1.1 部署模式对比

| 部署模式 | 适用场景 | 优点 | 缺点 |
|----|----|----|----|
| 单体模式 | PoC 验证、小团队 | 部署简单、成本低 | 扩展性一般 |
| 微服务模式 | 中大型团队 | 服务可独立扩展 | 运维复杂度较高 |
| AI Gateway 模式 | 企业级应用 | AI 能力统一治理 | 建设和运维成本较高 |

---

## 2. 单体模式部署（PoC / 小团队）

### 2.1 架构说明

单体模式将系统所有功能打包在一个应用中，适合快速验证和小规模使用：

- FastAPI 单服务  
- 内嵌向量数据库 SDK  
- 直连 Neo4j  
- 本地 MySQL  

---

### 2.2 资源配置

| 组件 | 配置 | 说明 |
|----|----|----|
| 应用服务器 | 4 核 CPU / 8GB 内存 | 运行 FastAPI 应用 |
| MySQL | 2 核 CPU / 4GB 内存 | 关系数据存储 |
| Milvus | 4 核 CPU / 8GB 内存 | 向量检索 |
| Neo4j | 2 核 CPU / 4GB 内存 | 图数据库 |

---

### 2.3 部署步骤

1. **安装依赖环境**
   ```bash
   sudo apt-get update
   sudo apt-get install python3.9 mysql-server docker docker-compose
   ```

2. **启动数据库服务**

   ```bash
   docker-compose up -d milvus neo4j mysql
   ```

3. **初始化数据库**

   ```bash
   python scripts/init_db.py
   ```

4. **配置环境变量**

   ```bash
   cp .env.example .env
   # 编辑 .env 文件，配置 API Key 等
   ```

5. **启动应用**

   ```bash
   uvicorn app.main:app --host 0.0.0.0 --port 8000
   ```

---

## 3. 微服务模式部署（推荐）

### 3.1 架构说明

微服务模式将系统拆分为多个独立服务，支持弹性扩展和独立部署：

* API Gateway：Nginx / Kong
* 需求处理服务：需求上传、解析与标准化
* 知识管理服务：测试知识抽取与维护
* 向量检索服务：向量数据库封装访问
* 图谱服务：Neo4j 查询与子图扩展
* LLM 调度服务：统一管理大模型调用

---

### 3.2 资源配置

| 组件          | 配置                | 说明         |
| ----------- | ----------------- | ---------- |
| API Gateway | 2 核 CPU / 4GB 内存  | 流量入口（1 实例） |
| 需求处理服务      | 4 核 CPU / 8GB 内存  | 2–3 实例     |
| 知识管理服务      | 4 核 CPU / 8GB 内存  | 2–3 实例     |
| 向量检索服务      | 2 核 CPU / 4GB 内存  | 2 实例       |
| 图谱服务        | 2 核 CPU / 4GB 内存  | 2 实例       |
| LLM 调度服务    | 4 核 CPU / 8GB 内存  | 2–3 实例     |
| MySQL       | 4 核 CPU / 8GB 内存  | 主从复制       |
| Milvus      | 8 核 CPU / 16GB 内存 | 集群部署       |
| Neo4j       | 4 核 CPU / 8GB 内存  | 单实例或集群     |
| Redis       | 2 核 CPU / 4GB 内存  | 缓存 / 消息队列  |

---

### 3.3 Kubernetes 部署

推荐使用 Kubernetes 进行容器编排和服务治理。

**核心配置文件：**

* `deployment.yaml`：服务部署配置
* `service.yaml`：服务暴露配置
* `ingress.yaml`：Ingress 路由规则
* `configmap.yaml`：环境变量与配置
* `secret.yaml`：密钥与敏感信息

---

## 4. AI Gateway 模式部署（企业级）

### 4.1 架构说明

在微服务架构基础上，引入 AI Gateway 统一管理 AI 能力：

* 统一 Prompt 管理与版本控制
* 多模型路由（GPT-4 / Claude / 本地模型）
* Token 消耗监控与预算控制

---

### 4.2 AI Gateway 配置

| 配置项         | 说明                  |
| ----------- | ------------------- |
| Prompt 版本管理 | 集中管理 Prompt 模板，支持回滚 |
| 模型路由策略      | 根据任务类型与成本选择模型       |
| Token 限流    | 限制用户或项目的 Token 使用   |
| 成本统计        | 实时统计 Token 消耗与费用    |

---

## 5. 监控与运维

### 5.1 日志管理

推荐使用 **ELK Stack** 或 **Loki**：

* 应用日志：各服务运行日志
* 访问日志：API 请求记录
* LLM 调用日志：Prompt 与生成结果
* 错误日志：异常与错误堆栈

---

### 5.2 指标监控

使用 **Prometheus + Grafana** 进行监控。

| 指标类型  | 关键指标                  |
| ----- | --------------------- |
| 服务健康  | 可用性、成功率、错误率           |
| 性能指标  | 响应时间（P50/P95/P99）、QPS |
| 资源使用  | CPU、内存、磁盘 IO          |
| 业务指标  | 生成任务数、用例确认率、Token 消耗  |
| 数据库指标 | 连接数、慢查询、锁等待           |

---

### 5.3 告警配置

关键告警规则：

* 服务不可用超过 **1 分钟**
* P99 响应时间超过 **30 秒**
* 错误率超过 **5%**
* Token 日消耗超过预算 **80%**
* 数据库连接池使用率超过 **80%**

---

## 6. 安全配置

### 6.1 网络安全

* HTTPS：所有外部接口强制 HTTPS
* 防火墙：仅开放必要端口
* VPC：数据库部署在私有网络

---

### 6.2 数据安全

* 敏感数据加密存储
* 基于角色的访问控制（RBAC）
* 全量审计日志记录

---

### 6.3 API 安全

* JWT Token 认证
* API 调用限流
* 严格的参数与输入校验

---

## 7. 备份与恢复

### 7.1 备份策略

| 数据类型  | 备份频率 | 保留时间 | 存储位置 |
| ----- | ---- | ---- | ---- |
| MySQL | 每天全量 | 30 天 | 对象存储 |
| 向量数据库 | 每周快照 | 60 天 | 对象存储 |
| Neo4j | 每周全量 | 60 天 | 对象存储 |

---

### 7.2 恢复流程

1. **关系数据库**

   ```bash
   mysql -u root -p < backup.sql
   ```

2. **向量数据库**

   * 从快照恢复 Collection

3. **图数据库**

   ```bash
   neo4j-admin restore --from=/backup/graph.dump
   ```

---

## 8. 扩展与优化

### 8.1 水平扩展

* 应用服务：增加实例数量
* 数据库：读写分离、增加从库
* 向量数据库：集群与数据分片

---

### 8.2 性能优化

* Redis 缓存热点数据
* 异步处理耗时任务（消息队列）
* 优化数据库与服务连接池配置